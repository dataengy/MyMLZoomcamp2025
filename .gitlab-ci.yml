---
# GitLab CI/CD Pipeline for MyMLZoomcamp2025

stages:
    - lint
    - test
    - notebooks
    - build

variables:
    PIP_CACHE_DIR: $CI_PROJECT_DIR/.cache/pip
    UV_CACHE_DIR: $CI_PROJECT_DIR/.cache/uv
    PYTHON_VERSION: '3.13'

# Cache dependencies
.python-cache: &python-cache
    cache:
        key: ${CI_COMMIT_REF_SLUG}
        paths:
            - .cache/pip
            - .cache/uv
            - .venv

# Base job for Python setup
.python-base:
    image: python:3.13
    before_script:
        - pip install uv
        - uv sync --frozen
    <<: *python-cache

# Linting jobs
lint:python:
    extends: .python-base
    stage: lint
    script:
        - uv run ruff check .
        - uv run ruff format --check .
    allow_failure: false

lint:shell:
    image: koalaman/shellcheck-alpine:latest
    stage: lint
    before_script:
        - apk add --no-cache shfmt
    script:
        - find scripts -name "*.sh" -exec shellcheck {} +
        - find scripts -name "*.sh" -exec shfmt -d -i 2 -ci {} +
    allow_failure: false

lint:yaml:
    image: python:3.13-alpine
    stage: lint
    before_script:
        - pip install yamllint
    script:
        - yamllint .
    allow_failure: false

lint:notebooks:
    extends: .python-base
    stage: lint
    script:
        - ./scripts/notebooks/lint_notebooks.sh
    allow_failure: false

# Test jobs
test:unit:
    extends: .python-base
    stage: test
    script:
        - uv run pytest -v --cov=src --cov-report=term --cov-report=xml
    coverage: /TOTAL.*\s+(\d+%)$/
    artifacts:
        reports:
            coverage_report:
                coverage_format: cobertura
                path: coverage.xml
        paths:
            - coverage.xml
        expire_in: 1 week

test:notebooks-sanitized:
    extends: .python-base
    stage: notebooks
    script:
        - ./scripts/notebooks/check_sanitized.sh
    allow_failure: false

test:notebooks-execution:
    extends: .python-base
    stage: notebooks
    script:
        - ./scripts/notebooks/test_notebooks.sh
    allow_failure: true  # Can be slow, make optional
    only:
        - main
        - merge_requests

# Build Docker image (optional)
build:docker:
    stage: build
    image: docker:latest
    services:
        - docker:dind
    script:
        - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .
        - docker build -t $CI_REGISTRY_IMAGE:latest .
    only:
        - main
    when: manual
